name: Daily Stock Scan (CN A-Share)

on:
  # å®šæ—¶è§¦å‘ - åŒ—äº¬æ—¶é—´
  schedule:
    # UTC 09:30 = åŒ—äº¬ 17:30 (ç›˜å30åˆ†é’Ÿ)
    - cron: '30 9 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      scan_date:
        description: 'Scan date (YYYY-MM-DD), leave empty for today'
        required: false
        default: ''
      limit:
        description: 'Limit number of stocks (0 = all)'
        required: false
        default: '0'

# æƒé™ - å…è®¸å†™å…¥ä»“åº“
permissions:
  contents: write

env:
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
  TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}


jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # æœ€é•¿è¿è¡Œ2å°æ—¶ (Aè‚¡çº¦5000åª)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy plotly tushare tqdm requests python-dotenv
      
      - name: Run CN A-Share scan
        working-directory: versions/v2
        env:
          TZ: Asia/Shanghai
          PYTHONPATH: ${{ github.workspace }}/versions/v2
        run: |
          # ç¡®å®šæ‰«ææ—¥æœŸ (ä½¿ç”¨åŒ—äº¬æ—¶é—´)
          SCAN_DATE="${{ github.event.inputs.scan_date }}"
          if [ -z "$SCAN_DATE" ]; then
            # ä½¿ç”¨åŒ—äº¬æ—¶é—´è·å–æ—¥æœŸ
            SCAN_DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          fi
          
          LIMIT="${{ github.event.inputs.limit }}"
          if [ -z "$LIMIT" ]; then
            LIMIT="0"
          fi
          
          echo "ğŸ“… Scanning CN A-Shares for date: $SCAN_DATE (Beijing Time)"
          echo "ğŸ“Š Stock limit: $LIMIT"
          echo "ğŸ”§ PYTHONPATH: $PYTHONPATH"
          
          # åˆ›å»ºæ•°æ®åº“ç›®å½•
          mkdir -p db
          
          # è¿è¡ŒAè‚¡æ‰«æ
          python services/scan_service.py --date "$SCAN_DATE" --market CN --workers 10 --limit "$LIMIT"
      
      - name: Generate scan report
        working-directory: versions/v2
        run: |
          python -c "
          from db.database import get_db_stats, query_scan_results, get_scanned_dates
          import json
          
          stats = get_db_stats()
          print('ğŸ“Š Scan Statistics:')
          print(f'   Total records: {stats[\"total_records\"]}')
          print(f'   Total symbols: {stats[\"total_symbols\"]}')
          print(f'   Date range: {stats[\"min_date\"]} ~ {stats[\"max_date\"]}')
          
          # è·å–æœ€æ–°æ‰«æç»“æœ
          dates = get_scanned_dates()
          if dates:
              latest = dates[0]
              results = query_scan_results(scan_date=latest, limit=20)
              
              print(f'\nğŸ† Top 20 A-Share signals for {latest}:')
              for r in results:
                  print(f'   {r[\"symbol\"]:10} | Â¥{r[\"price\"]:8.2f} | BLUE: {r[\"blue_daily\"]:5.1f} | Week: {r[\"blue_weekly\"]:5.1f}')
              
              # ä¿å­˜æ‘˜è¦åˆ°æ–‡ä»¶
              summary = {
                  'date': latest,
                  'market': 'CN',
                  'total_signals': len(query_scan_results(scan_date=latest)),
                  'top_10': [{'symbol': r['symbol'], 'price': r['price'], 'blue_daily': r['blue_daily']} for r in results[:10]]
              }
              with open('scan_summary_cn.json', 'w') as f:
                  json.dump(summary, f, indent=2)
          "
      
      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-database-cn-${{ github.run_number }}
          path: versions/v2/db/coral_creek.db
          retention-days: 30
      
      - name: Upload scan summary
        uses: actions/upload-artifact@v4
        with:
          name: scan-summary-cn-${{ github.run_number }}
          path: versions/v2/scan_summary_cn.json
          retention-days: 30
          if-no-files-found: ignore
      
      # æäº¤æ•°æ®åº“åˆ°ä»“åº“ - ç”¨äº Render
      - name: Commit database to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ•°æ®åº“æ–‡ä»¶
          git add versions/v2/db/coral_creek.db || true
          git add versions/v2/scan_summary_cn.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Auto-update: CN A-Share scan results for $(TZ='Asia/Shanghai' date +%Y-%m-%d)"
            git pull --rebase origin main || true
            git push
          fi
