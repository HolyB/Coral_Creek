name: Daily Stock Scan (CN A-Share)

on:
  # å®šæ—¶è§¦å‘ - åŒ—äº¬æ—¶é—´
  schedule:
    # ç›˜å‰: UTC 01:00 = åŒ—äº¬ 9:00 AM
    - cron: '0 1 * * 1-5'
    # ç›˜ä¸­: UTC 05:00 = åŒ—äº¬ 13:00 (1:00 PM)
    - cron: '0 5 * * 1-5'
    # ç›˜å: UTC 09:30 = åŒ—äº¬ 17:30 (30åˆ†é’Ÿå)
    - cron: '30 9 * * 1-5'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      scan_date:
        description: 'Scan date (YYYY-MM-DD), leave empty for today'
        required: false
        default: ''
      limit:
        description: 'Limit number of stocks (0 = all)'
        required: false
        default: '0'

# æƒé™ - å…è®¸å†™å…¥ä»“åº“
permissions:
  contents: write

env:
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
  TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}


jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # æœ€é•¿è¿è¡Œ2å°æ—¶ (Aè‚¡çº¦5000åª)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy plotly tushare tqdm requests python-dotenv
      
      - name: Run CN A-Share scan
        working-directory: versions/v2
        env:
          TZ: Asia/Shanghai
          PYTHONPATH: ${{ github.workspace }}/versions/v2
        run: |
          # ç¡®å®šæ‰«ææ—¥æœŸ (ä½¿ç”¨åŒ—äº¬æ—¶é—´)
          SCAN_DATE="${{ github.event.inputs.scan_date }}"
          if [ -z "$SCAN_DATE" ]; then
            # ä½¿ç”¨åŒ—äº¬æ—¶é—´è·å–æ—¥æœŸ
            SCAN_DATE=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          fi
          
          LIMIT="${{ github.event.inputs.limit }}"
          if [ -z "$LIMIT" ]; then
            LIMIT="0"
          fi
          
          echo "ğŸ“… Scanning CN A-Shares for date: $SCAN_DATE (Beijing Time)"
          echo "ğŸ“Š Stock limit: $LIMIT"
          echo "ğŸ”§ PYTHONPATH: $PYTHONPATH"
          
          # åˆ›å»ºæ•°æ®åº“ç›®å½•
          mkdir -p db
          
          # è¿è¡ŒAè‚¡æ‰«æ
          python services/scan_service.py --date "$SCAN_DATE" --market CN --workers 10 --limit "$LIMIT"
      
      - name: Generate scan report
        working-directory: versions/v2
        run: |
          python -c "
          from db.database import get_db_stats, query_scan_results, get_scanned_dates, get_stock_info_batch
          import json
          
          stats = get_db_stats()
          print('ğŸ“Š Scan Statistics:')
          print(f'   Total records: {stats[\"total_records\"]}')
          print(f'   Total symbols: {stats[\"total_symbols\"]}')
          print(f'   Date range: {stats[\"min_date\"]} ~ {stats[\"max_date\"]}')
          
          # è·å–æœ€æ–°æ‰«æç»“æœ
          dates = get_scanned_dates(market='CN')
          if dates:
              latest = dates[0]
              results = query_scan_results(scan_date=latest, market='CN', limit=20)
              
              # è·å–è‚¡ç¥¨åç§°
              symbols = [r['symbol'] for r in results]
              stock_info = get_stock_info_batch(symbols) if symbols else {}
              
              print(f'\nğŸ† Top 20 A-Share signals for {latest}:')
              for r in results:
                  info = stock_info.get(r['symbol'], {})
                  name = info.get('name', '')[:8] if info else ''
                  print(f'   {r[\"symbol\"]:10} | {name:8} | Â¥{r[\"price\"]:8.2f} | BLUE: {r[\"blue_daily\"]:5.1f}')
              
              # æ„å»º top_signals
              top_signals = []
              for r in results[:15]:
                  info = stock_info.get(r['symbol'], {})
                  top_signals.append({
                      'symbol': r['symbol'],
                      'name': info.get('name', '') if info else '',
                      'price': r['price'],
                      'day_blue': r['blue_daily'],
                      'week_blue': r['blue_weekly']
                  })
              
              # ä¿å­˜æ‘˜è¦åˆ°æ–‡ä»¶
              summary = {
                  'date': latest,
                  'market': 'CN',
                  'total_signals': len(query_scan_results(scan_date=latest, market='CN')),
                  'top_signals': top_signals
              }
              with open('scan_summary_cn.json', 'w') as f:
                  json.dump(summary, f, indent=2, ensure_ascii=False)
          "
      
      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-database-cn-${{ github.run_number }}
          path: versions/v2/db/coral_creek.db
          retention-days: 30
      
      - name: Upload scan summary
        uses: actions/upload-artifact@v4
        with:
          name: scan-summary-cn-${{ github.run_number }}
          path: versions/v2/scan_summary_cn.json
          retention-days: 30
          if-no-files-found: ignore
      
      # åŒæ­¥åˆ° Supabase äº‘æ•°æ®åº“
      - name: Sync to Supabase
        working-directory: versions/v2
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          pip install supabase
          python scripts/sync_to_supabase.py --days 3
      
      # å‘é€é€šçŸ¥ (Telegram + Email)
      - name: Send notifications
        working-directory: versions/v2
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SENDER: ${{ secrets.SMTP_SENDER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
        run: |
          # For CN market, rename summary file temporarily
          if [ -f scan_summary_cn.json ]; then
            mv scan_summary_cn.json scan_summary.json
          fi
          python scripts/send_notification.py
          if [ -f scan_summary.json ]; then
            mv scan_summary.json scan_summary_cn.json
          fi
      
      # æäº¤æ•°æ®åº“åˆ°ä»“åº“ - ç”¨äº Render
      - name: Commit database to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ•°æ®åº“æ–‡ä»¶
          git add versions/v2/db/coral_creek.db || true
          git add versions/v2/scan_summary_cn.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Auto-update: CN A-Share scan results for $(TZ='Asia/Shanghai' date +%Y-%m-%d)"
            
            # å°è¯• rebaseï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ ours ç­–ç•¥åˆå¹¶
            if ! git pull --rebase origin main; then
              echo "Rebase failed, resolving conflicts with ours strategy..."
              git rebase --abort || true
              git pull -X ours origin main || true
              git push || git push --force-with-lease
            else
              git push
            fi
          fi
