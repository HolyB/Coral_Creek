name: Daily Stock Scan

on:
  # å®šæ—¶è§¦å‘ - ç¾ä¸œæ—¶é—´
  schedule:
    # UTC 21:30 = ç¾ä¸œ 16:30 (ç›˜å30åˆ†é’Ÿ)
    - cron: '30 21 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      scan_date:
        description: 'Scan date (YYYY-MM-DD), leave empty for today'
        required: false
        default: ''
      limit:
        description: 'Limit number of stocks (0 = all)'
        required: false
        default: '0'

# æƒé™ - å…è®¸å†™å…¥ä»“åº“
permissions:
  contents: write

env:
  POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}


jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æœ€é•¿è¿è¡Œ1å°æ—¶
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy plotly polygon-api-client tqdm requests python-dotenv
      
      - name: Run daily scan
        working-directory: versions/v2
        env:
          TZ: America/New_York
          PYTHONPATH: ${{ github.workspace }}/versions/v2
        run: |
          # ç¡®å®šæ‰«ææ—¥æœŸ (ä½¿ç”¨ç¾ä¸œæ—¶é—´)
          SCAN_DATE="${{ github.event.inputs.scan_date }}"
          if [ -z "$SCAN_DATE" ]; then
            # ä½¿ç”¨ç¾ä¸œæ—¶é—´è·å–æ—¥æœŸ
            SCAN_DATE=$(TZ='America/New_York' date +%Y-%m-%d)
          fi
          
          LIMIT="${{ github.event.inputs.limit }}"
          if [ -z "$LIMIT" ]; then
            LIMIT="0"
          fi
          
          echo "ğŸ“… Scanning for date: $SCAN_DATE (Eastern Time)"
          echo "ğŸ“Š Stock limit: $LIMIT"
          echo "ğŸ”§ PYTHONPATH: $PYTHONPATH"
          
          # åˆ›å»ºæ•°æ®åº“ç›®å½•
          mkdir -p db
          
          # è¿è¡Œæ‰«æ
          python services/scan_service.py --date "$SCAN_DATE" --workers 10 --limit "$LIMIT"
      
      - name: Generate scan report
        working-directory: versions/v2
        run: |
          python -c "
          from db.database import get_db_stats, query_scan_results, get_scanned_dates
          import json
          
          stats = get_db_stats()
          print('ğŸ“Š Scan Statistics:')
          print(f'   Total records: {stats[\"total_records\"]}')
          print(f'   Total symbols: {stats[\"total_symbols\"]}')
          print(f'   Date range: {stats[\"min_date\"]} ~ {stats[\"max_date\"]}')
          
          # è·å–æœ€æ–°æ‰«æç»“æœ
          dates = get_scanned_dates()
          if dates:
              latest = dates[0]
              results = query_scan_results(scan_date=latest, limit=20)
              
              print(f'\nğŸ† Top 20 signals for {latest}:')
              for r in results:
                  print(f'   {r[\"symbol\"]:6} | \${r[\"price\"]:8.2f} | BLUE: {r[\"blue_daily\"]:5.1f} | Week: {r[\"blue_weekly\"]:5.1f}')
              
              # ä¿å­˜æ‘˜è¦åˆ°æ–‡ä»¶
              summary = {
                  'date': latest,
                  'total_signals': len(query_scan_results(scan_date=latest)),
                  'top_10': [{'symbol': r['symbol'], 'price': r['price'], 'blue_daily': r['blue_daily']} for r in results[:10]]
              }
              with open('scan_summary.json', 'w') as f:
                  json.dump(summary, f, indent=2)
          "
      
      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-database-${{ github.run_number }}
          path: versions/v2/db/coral_creek.db
          retention-days: 30
      
      - name: Upload scan summary
        uses: actions/upload-artifact@v4
        with:
          name: scan-summary-${{ github.run_number }}
          path: versions/v2/scan_summary.json
          retention-days: 30
          if-no-files-found: ignore
      
      # å¯é€‰: å‘é€ Telegram é€šçŸ¥
      - name: Send Telegram notification
        if: ${{ env.TELEGRAM_BOT_TOKEN != '' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          cd versions/v2
          if [ -f scan_summary.json ]; then
            SUMMARY=$(cat scan_summary.json)
            DATE=$(echo $SUMMARY | python -c "import sys,json; print(json.load(sys.stdin)['date'])")
            TOTAL=$(echo $SUMMARY | python -c "import sys,json; print(json.load(sys.stdin)['total_signals'])")
            
            MESSAGE="ğŸŒŠ *Coral Creek Daily Scan*%0AğŸ“… Date: $DATE%0AğŸ“Š Signals found: $TOTAL%0A%0Aâœ… Scan completed successfully!"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown"
          fi
      
      # æäº¤æ•°æ®åº“åˆ°ä»“åº“ - ç”¨äº Streamlit Cloud
      - name: Commit database to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ•°æ®åº“æ–‡ä»¶
          git add versions/v2/db/coral_creek.db || true
          git add versions/v2/scan_summary.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Auto-update: Scan results for $(TZ='America/New_York' date +%Y-%m-%d)"
            
            # å°è¯• rebaseï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ ours ç­–ç•¥åˆå¹¶
            if ! git pull --rebase origin main; then
              echo "Rebase failed, resolving conflicts with ours strategy..."
              git rebase --abort || true
              git pull -X ours origin main || true
              git push || git push --force-with-lease
            else
              git push
            fi
          fi


