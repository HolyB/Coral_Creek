name: Realtime Market Monitor

on:
  # 每30分钟运行一次
  schedule:
    # === 美股交易时间 ===
    # 9:30-16:00 ET = UTC 14:30-21:00 (冬令时) / UTC 13:30-20:00 (夏令时)
    - cron: '0,30 13-21 * * 1-5'   # 覆盖两个时区
    
    # === A股交易时间 ===
    # 9:30-11:30, 13:00-15:00 CST = UTC 1:30-3:30, 5:00-7:00
    - cron: '0,30 1-3 * * 1-5'     # 上午盘 (UTC)
    - cron: '0,30 5-7 * * 1-5'     # 下午盘 (UTC)
    
  # 手动触发
  workflow_dispatch:
    inputs:
      market:
        description: 'Market to monitor'
        required: true
        default: 'both'
        type: choice
        options:
          - US
          - CN
          - both
      force:
        description: 'Force run (ignore market hours)'
        type: boolean
        default: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pandas numpy pytz requests polygon-api-client supabase
      
      # 定时任务自动监控两个市场 (脚本内部会判断交易时间)
      - name: Monitor Markets (Scheduled)
        if: ${{ github.event_name == 'schedule' }}
        working-directory: versions/v3
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          pip install akshare || true
          python scripts/realtime_monitor.py --both
      
      # 手动触发 - 按选择的市场运行
      - name: Monitor Markets (Manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        working-directory: versions/v3
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          pip install akshare || true
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          if [ "${{ github.event.inputs.market }}" == "both" ]; then
            python scripts/realtime_monitor.py --both $FORCE_FLAG
          else
            python scripts/realtime_monitor.py --market ${{ github.event.inputs.market }} $FORCE_FLAG
          fi

