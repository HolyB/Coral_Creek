name: Social KOL Scan

on:
  schedule:
    - cron: "40 13 * * 1-5" # weekdays
  workflow_dispatch:
    inputs:
      tag:
        description: "Portfolio tag"
        required: false
        default: "AUTO_SOCIAL_KOL"
      horizon_days:
        description: "Evaluation horizon days"
        required: false
        default: "10"
      max_per_kol:
        description: "Max results per KOL"
        required: false
        default: "20"

permissions:
  contents: write

jobs:
  run-social-kol-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
      WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
      WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}
      WXPUSHER_TOPIC_IDS: ${{ secrets.WXPUSHER_TOPIC_IDS }}
      BARK_URL: ${{ secrets.BARK_URL }}
      BARK_GROUP: ${{ secrets.BARK_GROUP }}
      SOCIAL_KOL_LIST: ${{ secrets.SOCIAL_KOL_LIST }}
      TZ: America/New_York
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests python-dotenv supabase ddgs

      - name: Run social KOL scan (scheduled)
        if: github.event_name == 'schedule'
        working-directory: versions/v3
        run: |
          python scripts/run_social_kol_scan.py --tag AUTO_SOCIAL_KOL --horizon-days 10 --max-per-kol 20

      - name: Run social KOL scan (manual)
        if: github.event_name == 'workflow_dispatch'
        working-directory: versions/v3
        run: |
          python scripts/run_social_kol_scan.py \
            --tag "${{ github.event.inputs.tag }}" \
            --horizon-days "${{ github.event.inputs.horizon_days }}" \
            --max-per-kol "${{ github.event.inputs.max_per_kol }}"

      - name: Commit database updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add versions/v3/db/coral_creek.db || true
          if git diff --staged --quiet; then
            echo "No DB changes to commit"
          else
            git commit -m "ðŸ“¡ Auto-update: social KOL scan ($(date +%Y-%m-%d))"
            git pull --rebase origin main || true
            git push
          fi
