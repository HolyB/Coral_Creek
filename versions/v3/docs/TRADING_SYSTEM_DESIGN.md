# Coral Creek V3 - 一站式交易系统设计文档

## 📋 目录
1. [系统架构](#系统架构)
2. [导航结构](#导航结构)
3. [核心页面设计](#核心页面设计)
4. [Paper Trading 子账户系统](#paper-trading-子账户系统)
5. [Alpaca 实盘交易集成](#alpaca-实盘交易集成)
6. [风控系统](#风控系统)
7. [待实现功能](#待实现功能)

---

## 🏗️ 系统架构

### 设计理念
**"发现信号 → 快速决策 → 一键执行 → 实时监控"**

目标：让 Trader 在 5 分钟内完成每日交易决策，无需在多个页面之间跳转。

### 核心模块

```
Coral Creek V3
├── 📈 信号层 (Signal)
│   ├── 每日扫描 (BLUE/黑马/筹码)
│   ├── 策略精选 (ML Ranking)
│   └── 买卖点信号 (逃顶/抄底)
│
├── 📊 分析层 (Analysis)
│   ├── 个股详情 (K线/筹码/指标)
│   ├── 策略回测 (多策略对比)
│   └── ML 预测 (收益/方向/排名)
│
├── 💰 执行层 (Execution)
│   ├── Paper Trading (本地模拟盘)
│   ├── Alpaca Trading (真实模拟盘)
│   └── 订单管理 (下单/撤单)
│
└── 🛡️ 风控层 (Risk)
    ├── 硬风控 (Alpaca - 不可绕过)
    ├── 子账户风控 (Paper - 可配置)
    └── 持仓监控 (止损/止盈提醒)
```

---

## 🧭 导航结构

### 现有结构 (7个入口)
```
├── 🎯 每日工作台     ← 行动中心 + 策略精选
├── 📊 每日扫描       ← 全量扫描结果
├── 🔍 个股分析       ← 深度分析单只股票
├── 💰 每日买卖点     ← 信号推荐
├── 💼 组合管理       ← 持仓 + 风控
├── 🧪 策略实验室     ← 回测
└── 🤖 AI中心         ← AI选股
```

### 建议精简结构 (4个入口)
```
├── 🎯 每日机会       ← 整合: 工作台 + 买卖点 + 信号
├── 📊 全量扫描       ← 保留: 数据表格
├── 🔬 个股研究       ← 整合: 分析 + 回测 + ML
├── 💰 交易执行       ← 整合: Paper + Alpaca
└── 💼 持仓 (浮动栏)  ← 始终可见
```

---

## 📱 核心页面设计

### 🎯 每日机会页面 (Trading Dashboard)

**目的**: 5分钟完成每日决策

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📅 2026-02-06 行动摘要                                                       │
│ ┌──────────────┬──────────────┬──────────────┬──────────────┐               │
│ │ 🟢 买入机会   │ 🔴 卖出信号   │ ⚠️ 风险警告   │ 💼 持仓       │               │
│ │     12只     │     2只      │     1只      │  5只 +2.3%   │               │
│ └──────────────┴──────────────┴──────────────┴──────────────┘               │
├─────────────────────────────────────────────────────────────────────────────┤
│ [⚡ 今日行动] [🔎 发现新股] [🎯 策略精选] [💼 我的持仓]                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ ⚡ 今日行动                                                                  │
│ ┌─────────────────────────────┬─────────────────────────────────────────────┤
│ │ 🟢 今日买入机会              │ 🚨 逃顶 & 买入预警                          │
│ │ • 英伟达 NVDA (日BLUE 180)   │ • 🚨 三重逃顶: XXXX (86%)                  │
│ │ • Meta META (日BLUE 165)    │ • 🎯 黄金底: ZZZZ                          │
│ │ [查看详情] [💰 买入]         │ • 📈 趋势回调: YYYY                        │
│ └─────────────────────────────┴─────────────────────────────────────────────┤
│                                                                              │
│ ▼ 点击股票展开详情 + 决策面板 + 快速回测 + 一键买入                          │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ 💼 ALPACA POSITIONS (浮动底栏)                                               │
│ ┌────────┬────────┬────────┐                      📊 +$523 (+0.52%)         │
│ │ NVDA   │ META   │ AAPL   │                      账户: $96,523             │
│ │ +2.8%  │ -1.3%  │ +2.2%  │                      [展开详情 ▲]              │
│ └────────┴────────┴────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 股票详情 - 快速操作区

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ### 💰 快速操作                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ [🚀 Alpaca交易] [📈 快速回测] [🛒 模拟买入] [📐 仓位计算] [📋 观察列表]       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🚀 Alpaca 快速交易                                                           │
│ ┌────────────────────────────────────────────────────────────────────────┐  │
│ │ 股票: [NVDA] 数量: [10] 方向: [买入 ▼]   [🚀 执行]                      │  │
│ │ 💰 预估: $1,850.00 (占可用资金 1.9%) | 可用: $96,523                   │  │
│ └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│ 📈 快速回测 (该股票过去365天, 持有10天)                                       │
│ ┌───────────────┬───────────────┬───────────────┐                           │
│ │ BLUE>100      │ BLUE+黑马     │ 日周共振      │                           │
│ │ +48% 胜率62%  │ +35% 胜率75%  │ +52% 胜率68%  │                           │
│ └───────────────┴───────────────┴───────────────┘                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎮 Paper Trading 子账户系统

### 设计目的
允许同时测试多个策略，每个策略有独立的资金池和风控配置。

### 数据结构

```sql
-- 主账户表
paper_account (
    account_name VARCHAR(50) PRIMARY KEY,  -- 'default', 'trend_us', 'meanrev_cn'
    initial_capital REAL DEFAULT 100000,
    cash_balance REAL,
    created_at, updated_at
)

-- 子账户配置表
paper_account_config (
    account_name VARCHAR(50) PRIMARY KEY,
    strategy_note TEXT,                     -- 策略说明
    max_single_position_pct REAL DEFAULT 0.30,  -- 单票上限 30%
    max_drawdown_pct REAL DEFAULT 0.20      -- 最大回撤 20%
)

-- 持仓表 (按账户隔离)
paper_positions (
    account_name, symbol, market, shares, avg_cost
)

-- 交易记录表 (按账户隔离)
paper_trades (
    account_name, symbol, trade_type, price, shares, commission
)
```

### UI 设计

**侧边栏 - 全局子账户选择器**
```
🎮 模拟盘
全局子账户: [default ▼]
            - default
            - trend_us
            - meanrev_cn
            - high_vol_cn
```

**组合管理页 - 子账户管理**
```
策略子账户: [trend_us ▼]
当前风控: 单票≤30.0% | 最大回撤≤20.0%

[➕ 新建策略子账户]
    子账户名称: [trend_us        ]
    初始资金:   [20,000          ]
    [创建子账户]

[🛡️ 子账户风控设置]
    策略说明: [趋势追踪策略，只做日线BLUE>100的股票]
    单票仓位上限 (%): [---|----30----|----|]
    最大回撤阈值 (%): [---|----20----|----|]
    [保存风控设置]
```

### 已实现功能 ✅
- [x] `list_paper_accounts()` - 列出所有子账户
- [x] `create_paper_account(name, capital)` - 创建子账户
- [x] `get_paper_account_config(name)` - 获取配置
- [x] `update_paper_account_config(...)` - 更新配置
- [x] `paper_buy(..., account_name)` - 指定账户买入
- [x] `paper_sell(..., account_name)` - 指定账户卖出
- [x] 侧边栏全局子账户选择器
- [x] 组合管理页子账户切换
- [x] 风控配置 UI

---

## 🔌 Alpaca 实盘交易集成

### 配置方式

**环境变量**
```bash
ALPACA_API_KEY=your_api_key
ALPACA_SECRET_KEY=your_secret_key
ALPACA_PAPER=true
```

**Streamlit Secrets** (部署用)
```toml
# .streamlit/secrets.toml
[alpaca]
api_key = "your_api_key"
secret_key = "your_secret_key"
paper = true
```

### 已实现功能 ✅
- [x] 账户信息获取
- [x] 持仓查询
- [x] 市价单/限价单/止损单
- [x] 订单撤销
- [x] 侧边栏持仓摘要 Widget
- [x] 浮动底栏持仓展示
- [x] 股票详情页快速交易

---

## 🛡️ 风控系统

### 分层设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Alpaca 硬风控 (不可绕过)                       │
│  • 单票最大仓位: 20% (ALPACA_MAX_SINGLE_POSITION_PCT)           │
│  • 当日最大亏损: 3% (ALPACA_MAX_DAILY_LOSS_PCT)                 │
│  • 组合最大回撤: 15% (ALPACA_MAX_PORTFOLIO_DRAWDOWN_PCT)        │
├─────────────────────────────────────────────────────────────────┤
│                 Paper 子账户风控 (可配置)                        │
│  • 单票上限: 5%-80% (默认 30%)                                  │
│  • 最大回撤: 5%-80% (默认 20%)                                  │
│  • 策略说明备注                                                 │
├─────────────────────────────────────────────────────────────────┤
│                    持仓监控风控 (提醒)                           │
│  • 止损触发提醒                                                 │
│  • BLUE 信号转弱提醒                                            │
│  • 大幅亏损警告                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 风控拦截示例

**Alpaca 层**
```
风控拦截：NVDA 下单后仓位 $25,000 超过上限 $20,000 (20%)
风控拦截：当日亏损 3.5% 超过阈值 3.0%，禁止开新仓
风控拦截：组合回撤 16% 超过阈值 15%，禁止开新仓
```

**Paper 层**
```
策略风控拦截: NVDA 仓位将达 $8,000, 超过单票上限 $6,000 (30%)
策略风控拦截: 当前回撤 25% 已超过阈值 20%，禁止开新仓
```

---

## 📋 待实现功能

### 高优先级 ✅ 已完成
- [x] 子账户权益曲线可视化 (每个子账户独立图表)
- [x] 子账户策略绩效对比 (哪个策略表现最好)
- [x] 页面精简整合 (7 → 4 入口)
- [x] 浮动持仓栏增加快速卖出按钮

### 中优先级 ✅ 已完成
- [x] 侧边栏同时显示 Alpaca + Paper 子账户状态
- [x] 内联回测支持更多策略 (6个策略 + 持仓周期选择)
- [x] 策略回测结果缓存 (session_state)
- [x] 批量信号交易支持选择目标子账户 ⭐ NEW


### 低优先级 ✅ 已完成
- [x] 子账户导入/导出 (JSON)
- [x] 子账户删除功能
- [x] 历史权益曲线对比 ⭐ NEW
- [x] 移动端响应式优化 ⭐ NEW



---

## 📁 相关文件

| 文件 | 功能 |
|------|------|
| `app.py` | 主应用，侧边栏子账户选择器，4入口导航 |
| `services/portfolio_service.py` | 子账户 CRUD + 风控逻辑 + 绩效对比 |
| `execution/alpaca_trader.py` | Alpaca 集成 + 硬风控 |
| `components/alpaca_widget.py` | Alpaca + Paper UI 组件，6策略回测 |
| `components/stock_detail.py` | 股票详情 + 快速操作 |

---

*最后更新: 2026-02-06*

